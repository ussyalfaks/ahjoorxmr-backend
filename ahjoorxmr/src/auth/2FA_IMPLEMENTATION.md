# Two-Factor Authentication (2FA) Implementation

## Overview
This implementation adds optional TOTP-based Two-Factor Authentication to enhance account security.

## Features
- TOTP (Time-based One-Time Password) support
- QR code generation for authenticator apps
- Backup codes for account recovery
- Secure token verification
- 2FA enable/disable functionality

## API Endpoints

### 1. Enable 2FA
**POST** `/api/v1/auth/2fa/enable`

Generates QR code and backup codes for 2FA setup.

**Authentication:** Required (JWT)

**Response:**
```json
{
  "qrCode": "data:image/png;base64,...",
  "secret": "JBSWY3DPEHPK3PXP",
  "backupCodes": ["A1B2C3D4", "E5F6G7H8", ...]
}
```

### 2. Verify and Activate 2FA
**POST** `/api/v1/auth/2fa/verify`

Verifies TOTP token to complete 2FA setup.

**Authentication:** Required (JWT)

**Request Body:**
```json
{
  "token": "123456"
}
```

### 3. Disable 2FA
**POST** `/api/v1/auth/2fa/disable`

Disables 2FA with password and TOTP verification.

**Authentication:** Required (JWT)

**Request Body:**
```json
{
  "password": "user_password",
  "token": "123456"
}
```

### 4. Complete 2FA Login
**POST** `/api/v1/auth/2fa/login`

Verifies TOTP token or backup code to complete login.

**Request Body:**
```json
{
  "token": "123456"
}
```

## Database Schema

The User entity includes the following 2FA fields:

```typescript
@Column({ nullable: true })
twoFactorSecret?: string;

@Column({ default: false })
twoFactorEnabled: boolean;

@Column('simple-array', { nullable: true })
backupCodes?: string[];
```

## Security Considerations

1. **Secret Storage**: The `twoFactorSecret` is stored in the database. Consider encrypting this field in production.

2. **Backup Codes**: Backup codes are hashed using SHA-256 before storage. Users should save them securely.

3. **Rate Limiting**: The 2FA login endpoint is rate-limited to prevent brute force attacks.

4. **Token Validation**: TOTP tokens are time-based and expire quickly (typically 30 seconds).

## Setup Flow

1. User enables 2FA via `/auth/2fa/enable`
2. System generates secret and QR code
3. User scans QR code with authenticator app (Google Authenticator, Authy, etc.)
4. User verifies setup with TOTP token via `/auth/2fa/verify`
5. System activates 2FA and provides backup codes

## Login Flow with 2FA

1. User provides username/password
2. If 2FA is enabled, system prompts for TOTP token
3. User provides token from authenticator app or backup code
4. System verifies token via `/auth/2fa/login`
5. On success, user is authenticated

## Backup Codes

- 8 backup codes are generated by default
- Each code can be used once
- Codes are hashed before storage
- Users should store codes securely
- Used codes are removed from the database

## Dependencies

- `otplib`: TOTP generation and verification
- `qrcode`: QR code generation
- `crypto`: Backup code hashing

## TODO

The current implementation includes mock data. To complete the implementation:

1. Integrate with actual user authentication system
2. Implement password verification in disable endpoint
3. Update login flow to check `twoFactorEnabled` flag
4. Remove used backup codes after successful authentication
5. Add encryption for `twoFactorSecret` storage
6. Implement proper error handling and logging
7. Add unit and integration tests

## Testing

Use authenticator apps like:
- Google Authenticator
- Microsoft Authenticator
- Authy
- 1Password

Or test with the secret key directly using TOTP libraries.
